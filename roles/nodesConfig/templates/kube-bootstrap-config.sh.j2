#!/bin/bash

for node_name in {{ NODE_NAMES }} 
do
    export BOOTSTRAP_TOKEN=$({{ BIN_PATH }}kubeadm token create \
      --description kubelet-bootstrap-token \
      --groups system:bootstrappers:${node_name} \
      --kubeconfig ~/.kube/config)
    {{ BIN_PATH }}kubectl config set-cluster kubernetes \
      --certificate-authority=/etc/kubernetes/cert/ca.pem \
      --embed-certs=true \
      --server={{ KUBE_APISERVER }} \
      --kubeconfig=kubelet-bootstrap-${node_name}.kubeconfig
    {{ BIN_PATH }}kubectl config set-credentials kubelet-bootstrap \
      --token=${BOOTSTRAP_TOKEN} \
      --kubeconfig=kubelet-bootstrap-${node_name}.kubeconfig
    {{ BIN_PATH }}kubectl config set-context default \
      --cluster=kubernetes \
      --user=kubelet-bootstrap \
      --kubeconfig=kubelet-bootstrap-${node_name}.kubeconfig
    {{ BIN_PATH }}kubectl config use-context default --kubeconfig=kubelet-bootstrap-${node_name}.kubeconfig

    chmod 644 kubelet-bootstrap-${node_name}.kubeconfig
done

